// Copyright 2017 National Technology & Engineering Solutions of Sandia, LLC
// (NTESS), National Renewable Energy Laboratory, University of Texas Austin,
// Northwest Research Associates. Under the terms of Contract DE-NA0003525
// with NTESS, the U.S. Government retains certain rights in this software.
//
// This software is released under the BSD 3-clause license. See LICENSE file
// for more details.
//


#include "kernels/UnitTestKernelUtils.h"
#include "UnitTestUtils.h"
#include "UnitTestHelperObjects.h"

#include "kernel/MomentumSSTTAMSDiffElemKernel.h"

namespace {
namespace hex8_golds {
namespace tams_diff_elem {
static constexpr double rhs[24] = {
  0.00022402145095086,  -0.00024788580378163, 0,
  -0.00022726653298824, -0.0016520918600317,  0,
  -0.0017035746487741,  0.0016645970766884,   0,
  0.0017068197308115,   0.00023538058712494,  0,
  0.00022361430427938,  -0.00025239847680236, 0,
  -0.00022754576764908, -0.0016664427640037,  0,
  -0.0017290010722283,  0.0016815885327116,   0,
  0.001732932535598,    0.00023725270809441,  0,
};

static constexpr double lhs[24][24] = {
  {
    0.006324539888848,    0.0010791864616731,   0.0010503602376197,
    -0.0020654464902623,  -0.0010791864616731,  -0.0010503602376197,
    -0.0014079398045362,  -0.0010791864616731,  -0.00035012007920658,
    -5.0192960396893e-05, 0.0010791864616731,   0.00035012007920658,
    7.4594877098797e-06,  0.00035972882055771,  0.0010503602376197,
    -0.0013887223218339,  -0.00035972882055771, -0.0010503602376197,
    -0.00070272665431645, -0.00035972882055771, -0.00035012007920658,
    -0.00071697114521212, 0.00035972882055771,  0.00035012007920658,
  },
  {
    0.0010434066133029,   0.0063782096614033,   0.0010503602376197,
    0.0010434066133029,   3.9256660528607e-05,  0.00035012007920658,
    -0.0010434066133029,  -0.0014258297287213,  -0.00035012007920658,
    -0.0010434066133029,  -0.002190675959558,   -0.0010503602376197,
    0.00034780220443431,  2.534941189498e-05,   0.0010503602376197,
    0.00034780220443431,  -0.00068715460490362, 0.00035012007920658,
    -0.00034780220443431, -0.00070868996237815, -0.00035012007920658,
    -0.00034780220443431, -0.0014304654782658,  -0.0010503602376197,
  },
  {
    0.0010434066133029,   0.0010791864616731,   0.0063349703253233,
    0.0010434066133029,   0.00035972882055771,  2.4843548501913e-05,
    0.00034780220443431,  0.00035972882055771,  -0.00071117645828144,
    0.00034780220443431,  0.0010791864616731,   -4.6716148238486e-05,
    -0.0010434066133029,  -0.0010791864616731,  -0.0020897841753712,
    -0.0010434066133029,  -0.00035972882055771, -0.0013921991339923,
    -0.00034780220443431, -0.00035972882055771, -0.00070388559170259,
    -0.00034780220443431, -0.0010791864616731,  -0.0014160523662391,
  },
  {
    -0.0020768809251288,  0.0010645903973168,   0.0010420874322432,
    0.0062902365842488,   -0.0010645903973168,  -0.0010420874322432,
    -3.2435266550661e-05, -0.0010645903973168,  -0.00034736247741441,
    -0.0014020205732541,  0.0010645903973168,   0.00034736247741441,
    -0.0013870185965384,  0.00035486346577226,  0.0010420874322432,
    1.2570663596488e-05,  -0.00035486346577226, -0.0010420874322432,
    -0.0007055367103457,  -0.00035486346577226, -0.00034736247741441,
    -0.00069891517602764, 0.00035486346577226,  0.00034736247741441,
  },
  {
    -0.0010434066133029,  2.0524193484023e-05,  0.00034736247741441,
    -0.0010434066133029,  0.0063220122602696,   0.0010420874322432,
    0.0010434066133029,   -0.0021510241691773,  -0.0010420874322432,
    0.0010434066133029,   -0.0014126124652611,  -0.00034736247741441,
    -0.00034780220443431, -0.00068788355700081, 0.00034736247741441,
    -0.00034780220443431, 2.3162555603425e-05,  0.0010420874322432,
    0.00034780220443431,  -0.0014117330112213,  -0.0010420874322432,
    0.00034780220443431,  -0.00070244580669662, -0.00034736247741441,
  },
  {
    -0.0010434066133029,  0.00035486346577226,  9.2727109472356e-06,
    -0.0010434066133029,  0.0010645903973168,   0.0062882578126592,
    -0.00034780220443431, 0.0010645903973168,   -3.3094857080511e-05,
    -0.00034780220443431, 0.00035486346577226,  -0.00070663602789545,
    0.0010434066133029,   -0.00035486346577226, -0.0013863590060085,
    0.0010434066133029,   -0.0010645903973168,  -0.0020722637914198,
    0.00034780220443431,  -0.0010645903973168,  -0.0014004815286845,
    0.00034780220443431,  -0.00035486346577226, -0.00069869531251769,
  },
  {
    -0.0014491533381144,  -0.0010645903973168,  0.00036559145168955,
    5.1155446859906e-05,  0.0010645903973168,   -0.00036559145168955,
    0.0065410087244805,   0.0010645903973168,   -0.0010967743550686,
    -0.0022182792197096,  -0.0010645903973168,  0.0010967743550686,
    -0.0007267787471645,  -0.00035486346577226, 0.00036559145168955,
    -0.00071413108775912, 0.00035486346577226,  -0.00036559145168955,
    -1.3212468643781e-05, 0.00035486346577226,  -0.0010967743550686,
    -0.001470609309949,   -0.00035486346577226, 0.0010967743550686,
  },
  {
    -0.0010996538653008,  -0.0014316216041224,  0.00036559145168955,
    -0.0010996538653008,  -0.0020955570817657,  0.0010967743550686,
    0.0010996538653008,   0.0064884135225045,   -0.0010967743550686,
    0.0010996538653008,   -3.6503223100055e-05, -0.00036559145168955,
    -0.00036655128843359, -0.00072093483583383, 0.00036559145168955,
    -0.00036655128843359, -0.0014297019306343,  0.0010967743550686,
    0.00036655128843359,  -3.0744202635773e-05, -0.0010967743550686,
    0.00036655128843359,  -0.00074335064441244, -0.00036559145168955,
  },
  {
    -0.00036655128843359, -0.00035486346577226, -0.00071653067961924,
    -0.00036655128843359, -0.0010645903973168,  4.9715691743835e-05,
    -0.0010996538653008,  -0.0010645903973168,  0.0065366894591323,
    -0.0010996538653008,  -0.00035486346577226, -2.0411244224133e-05,
    0.00036655128843359,  0.00035486346577226,  -0.00072629882879247,
    0.00036655128843359,  0.0010645903973168,   -0.0014457939095102,
    0.0010996538653008,   0.0010645903973168,   -0.0022082009338971,
    0.0010996538653008,   0.00035486346577226,  -0.0014691695548329,
  },
  {
    4.122195603344e-05,   -0.0010791864616731,  0.00037356518882823,
    -0.0014524645017232,  0.0010791864616731,   -0.00037356518882823,
    -0.0021990205818234,  0.0010791864616731,   -0.0011206955664847,
    0.006598784638139,    -0.0010791864616731,  0.0011206955664847,
    -0.00073338972564531, -0.00035972882055771, 0.00037356518882823,
    -0.00073319829312656, 0.00035972882055771,  -0.00037356518882823,
    -0.0014801372382643,  0.00035972882055771,  -0.0011206955664847,
    -4.1796253589689e-05, -0.00035972882055771, 0.0011206955664847,
  },
  {
    0.0010996538653008,   -0.0021273846691266,  0.0011206955664847,
    0.0010996538653008,   -0.0014422307999094,  0.00037356518882823,
    -0.0010996538653008,  -9.9465530357042e-06, -0.00037356518882823,
    -0.0010996538653008,  0.0065680835326976,   -0.0011206955664847,
    0.00036655128843359,  -0.0014562586006987,  0.0011206955664847,
    0.00036655128843359,  -0.00072978705918862, 0.00037356518882823,
    -0.00036655128843359, -0.00075044589533502, -0.00037356518882823,
    -0.00036655128843359, -5.2029955403517e-05, -0.0011206955664847,
  },
  {
    0.00036655128843359,  -0.0010791864616731,  5.1742806625393e-05,
    0.00036655128843359,  -0.00035972882055771, -0.00071585497465872,
    0.0010996538653008,   -0.00035972882055771, 1.0807999370078e-05,
    0.0010996538653008,   -0.0010791864616731,  0.0066303471899149,
    -0.00036655128843359, 0.0010791864616731,   -0.0014770131531044,
    -0.00036655128843359, 0.00035972882055771,  -0.00073670524332388,
    -0.0010996538653008,  0.00035972882055771,  -0.0014906580888562,
    -0.0010996538653008,  0.0010791864616731,   -0.0022726665359671,
  },
  {
    1.946510962885e-05,   0.00036403591223916,  -0.0010503602376197,
    -0.00139211376039,    -0.00036403591223916, 0.0010503602376197,
    -0.00070672852828944, -0.00036403591223916, 0.00035012007920658,
    -0.00072158345460204, 0.00036403591223916,  -0.00035012007920658,
    0.006360556754605,    0.0010921077367175,   -0.0010503602376197,
    -0.0020756208059305,  -0.0010921077367175,  0.0010503602376197,
    -0.0014199454264552,  -0.0010921077367175,  0.00035012007920658,
    -6.4029888566642e-05, 0.0010921077367175,   -0.00035012007920658,
  },
  {
    0.00034965053256657,  4.1043179137735e-05,  -0.0010503602376197,
    0.00034965053256657,  -0.00068562000542056, -0.00035012007920658,
    -0.00034965053256657, -0.00071392121812573, 0.00035012007920658,
    -0.00034965053256657, -0.0014424625892441,  0.0010503602376197,
    0.0010489515976997,   0.0064252909631316,   -0.0010503602376197,
    0.0010489515976997,   4.386045897778e-05,   -0.00035012007920658,
    -0.0010489515976997,  -0.001441523495964,   0.00035012007920658,
    -0.0010489515976997,  -0.0022266672924927,  0.0010503602376197,
  },
  {
    0.0010489515976997,   0.0010921077367175,   -0.0020805510456506,
    0.0010489515976997,   0.00036403591223916,  -0.00139281808035,
    0.00034965053256657,  0.00036403591223916,  -0.00070696330160944,
    0.00034965053256657,  0.0010921077367175,   -0.0014215888396952,
    -0.0010489515976997,  -0.0010921077367175,  0.006362669714485,
    -0.0010489515976997,  -0.00036403591223916, 2.2986709428907e-05,
    -0.00034965053256657, -0.00036403591223916, -0.00072040958800202,
    -0.00034965053256657, -0.0010921077367175,  -6.332556860663e-05,
  },
  {
    -0.0013909245812078,  0.00035814146522698,  -0.0010420874322432,
    2.3032647175354e-05,  -0.00035814146522698, 0.0010420874322432,
    -0.00070860538139551, -0.00035814146522698, 0.00034736247741441,
    -0.00070240250388726, 0.00035814146522698,  -0.00034736247741441,
    -0.0020885988791371,  0.0010744243956809,   -0.0010420874322432,
    0.0063216225349854,   -0.0010744243956809,  0.0010420874322432,
    -4.1641279700096e-05, -0.0010744243956809,  0.00034736247741441,
    -0.001412482556833,   0.0010744243956809,   -0.00034736247741441,
  },
  {
    -0.00034965053256657, -0.00068737804974448, -0.00034736247741441,
    -0.00034965053256657, 3.5769046165971e-05,  -0.0010420874322432,
    0.00034965053256657,  -0.0014206428455193,  0.0010420874322432,
    0.00034965053256657,  -0.00070664797021747, 0.00034736247741441,
    -0.0010489515976997,  2.2040715252988e-05,  -0.00034736247741441,
    -0.0010489515976997,  0.0063598317319572,   -0.0010420874322432,
    0.0010489515976997,   -0.0021777536720714,  0.0010420874322432,
    0.0010489515976997,   -0.0014252189558236,  0.00034736247741441,
  },
  {
    -0.0010489515976997,  0.00035814146522698,  -0.0013874924984796,
    -0.0010489515976997,  0.0010744243956809,   -0.0020645743000393,
    -0.00034965053256657, 0.0010744243956809,   -0.0014044743638004,
    -0.00034965053256657, 0.00035814146522698,  -0.00070125847631118,
    0.0010489515976997,   -0.00035814146522698, 5.8722335341253e-06,
    0.0010489515976997,   -0.0010744243956809,  0.0063113262868006,
    0.00034965053256657,  -0.0010744243956809,  -4.5073362428342e-05,
    0.00034965053256657,  -0.00035814146522698, -0.00071432551927592,
  },
  {
    -0.00073422505738907, -0.00035814146522698, -0.00036559145168955,
    -0.00071324077644398, 0.00035814146522698,  0.00036559145168955,
    9.1264620299416e-06,  0.00035814146522698,  0.0010967743550686,
    -0.0014863922417133,  -0.00035814146522698, -0.0010967743550686,
    -0.0014714922687881,  -0.0010744243956809,  -0.00036559145168955,
    5.3826380805327e-05,  0.0010744243956809,   0.00036559145168955,
    0.0066080255165017,   0.0010744243956809,   0.0010967743550686,
    -0.0022656280150025,  -0.0010744243956809,  -0.0010967743550686,
  },
  {
    -0.00037235859893081, -0.00072711649053716, -0.00036559145168955,
    -0.00037235859893081, -0.0014366322737499,  -0.0010967743550686,
    0.00037235859893081,  -1.2199238525799e-05, 0.0010967743550686,
    0.00037235859893081,  -0.00074878361070355, 0.00036559145168955,
    -0.0011170757967924,  -0.0014501665682324,  -0.00036559145168955,
    -0.0011170757967924,  -0.0021163481111123,  -0.0010967743550686,
    0.0011170757967924,   0.0065440484148344,   0.0010967743550686,
    0.0011170757967924,   -5.2802121973374e-05, 0.00036559145168955,
  },
  {
    -0.00037235859893081, -0.00035814146522698, -0.00073084148376844,
    -0.00037235859893081, -0.0010744243956809,  -0.0014478072534437,
    -0.0011170757967924,  -0.0010744243956809,  -0.0021945729689692,
    -0.0011170757967924,  -0.00035814146522698, -0.0014762415208514,
    0.00037235859893081,  0.00035814146522698,  -0.00073015864454714,
    0.00037235859893081,  0.0010744243956809,   4.3675659943433e-05,
    0.0011170757967924,   0.0010744243956809,   0.006577573353916,
    0.0011170757967924,   0.00035814146522698,  -4.1627142279528e-05,
  },
  {
    -0.00073404305267027, -0.00036403591223916, -0.00037356518882823,
    -0.0007411591494645,  0.00036403591223916,  0.00037356518882823,
    -0.0014954056239152,  0.00036403591223916,  0.0011206955664847,
    -1.7913684575862e-05, -0.00036403591223916, -0.0011206955664847,
    3.9261974958547e-05,  -0.0010921077367175,  -0.00037356518882823,
    -0.0014763470707371,  0.0010921077367175,   0.00037356518882823,
    -0.0022448257387762,  0.0010921077367175,   0.0011206955664847,
    0.0066704323451805,   -0.0010921077367175,  -0.0011206955664847,
  },
  {
    0.00037235859893081,  -0.0014662762204944,  -0.0011206955664847,
    0.00037235859893081,  -0.00073699780611868, -0.00037356518882823,
    -0.00037235859893081, -0.0007548497693994,  0.00037356518882823,
    -0.00037235859893081, -3.0397714613334e-05, 0.0011206955664847,
    0.0011170757967924,   -0.0021574375285139,  -0.0011206955664847,
    0.0011170757967924,   -0.0014638630406996,  -0.00037356518882823,
    -0.0011170757967924,  -2.3158175228815e-05, 0.00037356518882823,
    -0.0011170757967924,  0.0066329802550681,   0.0011206955664847,
  },
  {
    0.00037235859893081,  -0.0010921077367175,  -0.001480570135378,
    0.00037235859893081,  -0.00036403591223916, -0.00074176244441321,
    0.0011170757967924,   -0.00036403591223916, -0.0014972155087613,
    0.0011170757967924,   -0.0010921077367175,  -0.0022574949326991,
    -0.00037235859893081, 0.0010921077367175,   4.1071859804677e-05,
    -0.00037235859893081, 0.00036403591223916,  -0.00073102657792672,
    -0.0011170757967924,  0.00036403591223916,  -8.864260345213e-06,
    -0.0011170757967924,  0.0010921077367175,   0.0066758619997189,
  },
};
} // namespace tams_diff_elem
} // hex8_golds
} // anonymous namespace

TEST_F(TAMSKernelHex8Mesh, NGP_tams_diff_elem)
{
  if (bulk_.parallel_size() > 1) return;

  fill_mesh_and_init_fields();

  // Setup solution options for default advection kernel
  solnOpts_.meshMotion_ = false;
  solnOpts_.meshDeformation_ = false;
  solnOpts_.externalMeshDeformation_ = false;
  solnOpts_.includeDivU_ = 0.0;
  solnOpts_.initialize_turbulence_constants();

  unit_test_utils::HelperObjects helperObjs(bulk_, stk::topology::HEX_8, 3, partVec_[0]);

  // Initialize the kernel
  std::unique_ptr<sierra::nalu::Kernel> kernel(
    new sierra::nalu::MomentumSSTTAMSDiffElemKernel<sierra::nalu::AlgTraitsHex8>(
      bulk_, solnOpts_, tvisc_,
      helperObjs.assembleElemSolverAlg->dataNeededByKernels_));

  // Add to kernels to be tested
  helperObjs.assembleElemSolverAlg->activeKernels_.push_back(kernel.get());

  // Populate LHS and RHS
  helperObjs.execute();

  EXPECT_EQ(helperObjs.linsys->lhs_.extent(0), 24u);
  EXPECT_EQ(helperObjs.linsys->lhs_.extent(1), 24u);
  EXPECT_EQ(helperObjs.linsys->rhs_.extent(0), 24u);

  namespace gold_values = ::hex8_golds::tams_diff_elem;
  unit_test_kernel_utils::expect_all_near(helperObjs.linsys->rhs_, gold_values::rhs);
  unit_test_kernel_utils::expect_all_near(helperObjs.linsys->lhs_, gold_values::lhs);
}
