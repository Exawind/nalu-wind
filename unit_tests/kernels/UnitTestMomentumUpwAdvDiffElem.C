// Copyright 2017 National Technology & Engineering Solutions of Sandia, LLC
// (NTESS), National Renewable Energy Laboratory, University of Texas Austin,
// Northwest Research Associates. Under the terms of Contract DE-NA0003525
// with NTESS, the U.S. Government retains certain rights in this software.
//
// This software is released under the BSD 3-clause license. See LICENSE file
// for more details.
//


#include "kernels/UnitTestKernelUtils.h"
#include "UnitTestUtils.h"
#include "UnitTestHelperObjects.h"

#include "kernel/MomentumUpwAdvDiffElemKernel.h"

namespace {
namespace hex8_golds {
namespace advection_diffusion {

static constexpr double rhs[24] = {
  0.012069186724258, 0.020406405129942, 0,
  0.032801620129894, -0.11442724064966, -8.673617379884e-19,
  0.027870341767088, 0.06955643379551, 0,
  -0.07274114862124, 0.02446440172421, 0,
  0.012069186724258, 0.020406405129942, 0,
  0.032801620129894, -0.11442724064966, 0,
  0.027870341767088, 0.06955643379551, 0,
  -0.07274114862124, 0.02446440172421, 0,
};

static constexpr double lhs[24][24] = {
  {
    0.1, 0.0125, 0.0125,
    -0.070071019570664, -0.0125, -0.0125,
    0, -0.0125, 0,
    -0.0049289804293356, 0.0125, 0,
    -0.025, 0, 0.0125,
    0, 0, -0.0125,
    0, 0, 0,
    0, 0, 0,
  },
  {
    0.0125, 0.1, 0.0125,
    0.0125, -0.045071019570664, 0,
    -0.0125, 0, 0,
    -0.0125, -0.029928980429336, -0.0125,
    0, -0.025, 0.0125,
    0, 0, 0,
    0, 0, 0,
    0, 0, -0.0125,
  },
  {
    0.0125, 0.0125, 0.1,
    0.0125, 0, -0.045071019570664,
    0, 0, 0,
    0, 0.0125, -0.0049289804293356,
    -0.0125, -0.0125, -0.05,
    -0.0125, 0, 0,
    0, 0, 0,
    0, -0.0125, 0,
  },
  {
    -0.029928980429336, 0.0125, 0.0125,
    0.18028407828266, -0.0125, -0.0125,
    0.035213058711993, -0.0125, 0,
    0, 0.0125, 0,
    0, 0, 0.0125,
    -0.025, 0, -0.0125,
    0, 0, 0,
    0, 0, 0,
  },
  {
    -0.0125, -0.0049289804293356, 0,
    -0.0125, 0.18028407828266, 0.0125,
    0.0125, 0.010213058711993, -0.0125,
    0.0125, 0, 0,
    0, 0, 0,
    0, -0.025, 0.0125,
    0, 0, -0.0125,
    0, 0, 0,
  },
  {
    -0.0125, 0, -0.0049289804293356,
    -0.0125, 0.0125, 0.18028407828266,
    0, 0.0125, 0.035213058711993,
    0, 0, 0,
    0.0125, 0, 0,
    0.0125, -0.0125, -0.05,
    0, -0.0125, 0,
    0, 0, 0,
  },
  {
    0, -0.0125, 0,
    -0.085213058711993, 0.0125, 0,
    0.1, 0.0125, -0.0125,
    0.010213058711993, -0.0125, 0.0125,
    0, 0, 0,
    0, 0, 0,
    -0.025, 0, -0.0125,
    0, 0, 0.0125,
  },
  {
    -0.0125, 0, 0,
    -0.0125, -0.11021305871199, 0.0125,
    0.0125, 0.1, -0.0125,
    0.0125, 0.035213058711993, 0,
    0, 0, 0,
    0, 0, 0.0125,
    0, -0.025, -0.0125,
    0, 0, 0,
  },
  {
    0, 0, 0,
    0, -0.0125, -0.085213058711993,
    -0.0125, -0.0125, 0.1,
    -0.0125, 0, 0.035213058711993,
    0, 0, 0,
    0, 0.0125, 0,
    0.0125, 0.0125, -0.05,
    0.0125, 0, 0,
  },
  {
    -0.045071019570664, -0.0125, 0,
    0, 0.0125, 0,
    -0.11021305871199, 0.0125, -0.0125,
    0.019715921717342, -0.0125, 0.0125,
    0, 0, 0,
    0, 0, 0,
    0, 0, -0.0125,
    -0.025, 0, 0.0125,
  },
  {
    0.0125, -0.070071019570664, 0.0125,
    0.0125, 0, 0,
    -0.0125, -0.085213058711993, 0,
    -0.0125, 0.019715921717342, -0.0125,
    0, 0, 0.0125,
    0, 0, 0,
    0, 0, 0,
    0, -0.025, -0.0125,
  },
  {
    0, -0.0125, -0.045071019570664,
    0, 0, 0,
    0.0125, 0, -0.085213058711993,
    0.0125, -0.0125, 0.019715921717342,
    0, 0.0125, 0,
    0, 0, 0,
    -0.0125, 0, 0,
    -0.0125, 0.0125, -0.05,
  },
  {
    -0.025, 0, -0.0125,
    0, 0, 0.0125,
    0, 0, 0,
    0, 0, 0,
    0.1, 0.0125, -0.0125,
    -0.070071019570664, -0.0125, 0.0125,
    0, -0.0125, 0,
    -0.0049289804293356, 0.0125, 0,
  },
  {
    0, -0.025, -0.0125,
    0, 0, 0,
    0, 0, 0,
    0, 0, 0.0125,
    0.0125, 0.1, -0.0125,
    0.0125, -0.045071019570664, 0,
    -0.0125, 0, 0,
    -0.0125, -0.029928980429336, 0.0125,
  },
  {
    0.0125, 0.0125, -0.05,
    0.0125, 0, 0,
    0, 0, 0,
    0, 0.0125, 0,
    -0.0125, -0.0125, 0.1,
    -0.0125, 0, -0.045071019570664,
    0, 0, 0,
    0, -0.0125, -0.0049289804293356,
  },
  {
    0, 0, -0.0125,
    -0.025, 0, 0.0125,
    0, 0, 0,
    0, 0, 0,
    -0.029928980429336, 0.0125, -0.0125,
    0.18028407828266, -0.0125, 0.0125,
    0.035213058711993, -0.0125, 0,
    0, 0.0125, 0,
  },
  {
    0, 0, 0,
    0, -0.025, -0.0125,
    0, 0, 0.0125,
    0, 0, 0,
    -0.0125, -0.0049289804293356, 0,
    -0.0125, 0.18028407828266, -0.0125,
    0.0125, 0.010213058711993, 0.0125,
    0.0125, 0, 0,
  },
  {
    -0.0125, 0, 0,
    -0.0125, 0.0125, -0.05,
    0, 0.0125, 0,
    0, 0, 0,
    0.0125, 0, -0.0049289804293356,
    0.0125, -0.0125, 0.18028407828266,
    0, -0.0125, 0.035213058711993,
    0, 0, 0,
  },
  {
    0, 0, 0,
    0, 0, 0,
    -0.025, 0, 0.0125,
    0, 0, -0.0125,
    0, -0.0125, 0,
    -0.085213058711993, 0.0125, 0,
    0.1, 0.0125, 0.0125,
    0.010213058711993, -0.0125, -0.0125,
  },
  {
    0, 0, 0,
    0, 0, -0.0125,
    0, -0.025, 0.0125,
    0, 0, 0,
    -0.0125, 0, 0,
    -0.0125, -0.11021305871199, -0.0125,
    0.0125, 0.1, 0.0125,
    0.0125, 0.035213058711993, 0,
  },
  {
    0, 0, 0,
    0, -0.0125, 0,
    -0.0125, -0.0125, -0.05,
    -0.0125, 0, 0,
    0, 0, 0,
    0, 0.0125, -0.085213058711993,
    0.0125, 0.0125, 0.1,
    0.0125, 0, 0.035213058711993,
  },
  {
    0, 0, 0,
    0, 0, 0,
    0, 0, 0.0125,
    -0.025, 0, -0.0125,
    -0.045071019570664, -0.0125, 0,
    0, 0.0125, 0,
    -0.11021305871199, 0.0125, 0.0125,
    0.019715921717342, -0.0125, -0.0125,
  },
  {
    0, 0, -0.0125,
    0, 0, 0,
    0, 0, 0,
    0, -0.025, 0.0125,
    0.0125, -0.070071019570664, -0.0125,
    0.0125, 0, 0,
    -0.0125, -0.085213058711993, 0,
    -0.0125, 0.019715921717342, 0.0125,
  },
  {
    0, -0.0125, 0,
    0, 0, 0,
    0.0125, 0, 0,
    0.0125, -0.0125, -0.05,
    0, 0.0125, -0.045071019570664,
    0, 0, 0,
    -0.0125, 0, -0.085213058711993,
    -0.0125, 0.0125, 0.019715921717342,
  },
};

} // advection_diffusion
} // hex8_golds
} // anonymous namespace

TEST_F(MomentumKernelHex8Mesh, NGP_momentum_upw_advection_diffusion)
{
  if (bulk_.parallel_size() > 1) return;

  fill_mesh_and_init_fields(false);

  // Setup solution options for default advection kernel
  solnOpts_.meshMotion_ = false;
  solnOpts_.meshDeformation_ = false;
  solnOpts_.externalMeshDeformation_ = false;
  solnOpts_.alphaMap_["velocity"] = 1.0;
  solnOpts_.alphaUpwMap_["velocity"] = 1.0;
  solnOpts_.upwMap_["velocity"] = 0.0;
  solnOpts_.shiftedGradOpMap_["velocity"] = true;
  solnOpts_.skewSymmetricMap_["velocity"] = true;

  unit_test_utils::HelperObjects helperObjs(bulk_, stk::topology::HEX_8, 3, partVec_[0]);

  // Initialize the kernel
  std::unique_ptr<sierra::nalu::Kernel> advKernel(
    new sierra::nalu::MomentumUpwAdvDiffElemKernel<sierra::nalu::AlgTraitsHex8>(
      bulk_, solnOpts_, &helperObjs.eqSystem, velocity_, viscosity_, dudx_,
      helperObjs.assembleElemSolverAlg->dataNeededByKernels_));

  // Register the kernel for execution
  helperObjs.assembleElemSolverAlg->activeKernels_.push_back(advKernel.get());

  // Populate LHS and RHS
  helperObjs.execute();

  EXPECT_EQ(helperObjs.linsys->lhs_.extent(0), 24u);
  EXPECT_EQ(helperObjs.linsys->lhs_.extent(1), 24u);
  EXPECT_EQ(helperObjs.linsys->rhs_.extent(0), 24u);

  namespace gold_values = ::hex8_golds::advection_diffusion;
  unit_test_kernel_utils::expect_all_near(
    helperObjs.linsys->rhs_, gold_values::rhs, 1.0e-14);
  unit_test_kernel_utils::expect_all_near<24>(
    helperObjs.linsys->lhs_, gold_values::lhs, 1.0e-14);
}
