// Copyright 2017 National Technology & Engineering Solutions of Sandia, LLC
// (NTESS), National Renewable Energy Laboratory, University of Texas Austin,
// Northwest Research Associates. Under the terms of Contract DE-NA0003525
// with NTESS, the U.S. Government retains certain rights in this software.
//
// This software is released under the BSD 3-clause license. See LICENSE file
// for more details.
//
// Copyright 2017 National Technology & Engineering Solutions of Sandia, LLC
// (NTESS), National Renewable Energy Laboratory, University of Texas Austin,
// Northwest Research Associates. Under the terms of Contract DE-NA0003525
// with NTESS, the U.S. Government retains certain rights in this software.
//
// This software is released under the BSD 3-clause license. See LICENSE file
// for more details.
//

#include <actuator/ActuatorParsingFAST.h>
#include <actuator/ActuatorFunctorsFAST.h>
#include <actuator/ActuatorBulkFAST.h>
#include <actuator/UtilitiesActuator.h>
#include "UnitTestActuatorUtil.h"
#include <gtest/gtest.h>

namespace sierra {
namespace nalu {

namespace {

//-----------------------------------------------------------------
class ActuatorBulkFastTests : public ::testing::Test
{
protected:
  std::string inputFileSurrogate_;
  const double tol_;
  std::vector<std::string> fastParseParams_{actuator_unit::nrel5MWinputs};
  const ActuatorMeta actMeta_;

  ActuatorBulkFastTests()
    : tol_(1e-8), actMeta_(1, ActuatorType::ActLineFASTNGP)
  {
  }
};


TEST_F(ActuatorBulkFastTests, initializeActuatorBulk)
{
  const YAML::Node y_node = actuator_unit::create_yaml_node(fastParseParams_);
  auto actMetaFast = actuator_FAST_parse(y_node, actMeta_);

  const fast::fastInputs& fi = actMetaFast.fastInputs_;
  ASSERT_EQ(fi.comm, NaluEnv::self().parallel_comm());
  ASSERT_EQ(fi.globTurbineData.size(), 1);
  ASSERT_EQ(fi.debug, true);
  ASSERT_EQ(fi.dryRun, false);
  ASSERT_EQ(fi.nTurbinesGlob, 1);
  ASSERT_EQ(fi.tStart, 0.0);
  ASSERT_EQ(fi.simStart, fast::init);
  ASSERT_EQ(fi.nEveryCheckPoint, 1);
  ASSERT_EQ(fi.dtFAST, 0.00625);
  ASSERT_EQ(fi.tMax, 0.0625);

  ASSERT_EQ(
    fi.globTurbineData[0].FASTInputFileName,
    "reg_tests/test_files/nrel5MWactuatorLine/nrel5mw.fst");
  ASSERT_EQ(fi.globTurbineData[0].FASTRestartFileName, "blah");
  ASSERT_EQ(fi.globTurbineData[0].TurbID, 0);
  ASSERT_EQ(fi.globTurbineData[0].numForcePtsBlade, 10);
  ASSERT_EQ(fi.globTurbineData[0].numForcePtsTwr, 10);
  ASSERT_EQ(fi.globTurbineData[0].air_density, 1.0);
  ASSERT_EQ(fi.globTurbineData[0].nacelle_area, 1.0);
  ASSERT_EQ(fi.globTurbineData[0].nacelle_cd, 1.0);

  try {
    ActuatorBulkFAST actBulk(actMetaFast, 0.0625);
    EXPECT_TRUE(actBulk.openFast_.isDebug());
  } catch (std::exception const& err) {
    FAIL() << err.what();
  }
}

TEST_F(ActuatorBulkFastTests, epsilonTowerAndAnisotropicEpsilon)
{

  const YAML::Node y_node = actuator_unit::create_yaml_node(fastParseParams_);
  auto actMetaFast = actuator_FAST_parse(y_node, actMeta_);
  try {
    ActuatorBulkFAST actBulk(actMetaFast, 0.0625);
    EXPECT_TRUE(actBulk.openFast_.isDebug());
  } catch (std::exception const& err) {
    FAIL() << err.what();
  }
}

}

}
}
